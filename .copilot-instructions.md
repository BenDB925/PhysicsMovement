# Copilot Agent Instructions — PhysicsDrivenMovementDemo

> Auto-read by Copilot/Claude on every session. Optimised for agents, not humans.

---

## Project Summary

Multiplayer ragdoll brawler (Gang Beasts–style). 2–4 players control physics-driven active-ragdoll characters that grab, punch, throw, and knock each other out. Built in **Unity 6 (6000.0.33f1, Built-in 3D RP)** with **Netcode for GameObjects (NGO)** for peer-to-peer networking. Characters are *always* ragdolls — muscle forces (ConfigurableJoint SLERP drives) keep them upright; zeroing those forces *is* the ragdoll/knockout state. Physics is host-authoritative at 100 Hz.

---

## Mandatory Reading — Load These First

| File | What it contains |
|------|-----------------|
| `CODING_STANDARDS.md` | **All** workflow, style, testing, architecture, documentation, and pre-commit review rules. Follow the Phase A→F workflow for every task. |
| `PLAN.md` | Full project plan with phase breakdown, agent task cards, joint hierarchy reference, networking diagram, and tuning parameter table. |
| `AGENT_TEST_RUNNING.md` | How to run EditMode/PlayMode tests from the terminal in batch mode, parse NUnit XML results, and troubleshoot failures. |
| `ARCHITECTURE.md` | High-level system diagram, data flow, key classes per system, integration points. |

---

## Systems & Namespaces

| Namespace / Folder | Purpose | Key Classes |
|--------------------|---------|-------------|
| `Character/` | Ragdoll body, balance, movement, state machine, combat | `RagdollSetup`, `BalanceController`, `GroundSensor`, `PlayerMovement`, `LegAnimator`, `CharacterState`, `HandGrabber`, `HitReceiver` |
| `Core/` | Game-wide config, utilities, constants | `GameSettings` |
| `Input/` | New Input System action maps | `PlayerInputActions` (asset) |
| `Networking/` | NGO components, RPCs, spawn management | `PlayerNetworkInput`, `GrabSync`, `GameManager` |
| `UI/` | All UI controllers and views | `ConnectionUI`, `HUD`, `MainMenuUI` |
| `GameLoop/` | Lobby, rounds, spectating | `LobbyManager`, `RoundManager`, `SpectatorCamera` |
| `Editor/` | Editor-only build tools (not shipped) | `RagdollBuilder`, `SceneBuilder` |
| `Tests/EditMode/` | NUnit EditMode tests (pure logic) | `GameSettingsTests` |
| `Tests/PlayMode/` | NUnit PlayMode tests (needs scene/physics) | `RagdollSetupTests` |

> **Update this table whenever a new system, namespace, or key class is added.**

---

## Architecture Snapshot

```
Input (Update)          Network (ServerRpc)
     │                        │
     ▼                        ▼
 ┌──────────────────────────────────┐
 │         HOST PHYSICS            │
 │   BalanceController (PD torque) │
 │   PlayerMovement (forces)       │
 │   HandGrabber (FixedJoints)     │
 │   HitReceiver (knockout)       │
 │   CharacterState (FSM)         │
 │   LegAnimator (joint targets)  │
 │         FixedUpdate @ 100 Hz    │
 └──────────────┬───────────────────┘
                │
        NetworkRigidbody sync
                │
     ┌──────────┴──────────┐
     ▼                     ▼
  Client 2              Client 3 …
 (kinematic)           (kinematic)
```

- **Clients** read input and send via `ServerRpc`. They do NOT apply physics forces (unless local prediction is added later).
- **Host** runs PhysX, applies all forces, owns all Rigidbody authority.
- **NetworkRigidbody** replicates transform state to clients. Core bodies (hips, torso) sync at 30 Hz; extremities at 15 Hz.

---

## Key Constraints & Decisions

| Constraint | Detail |
|------------|--------|
| Always-ragdoll | No kinematic mode. "Standing" = joint drives active. "Knocked out" = joint drives zeroed. |
| Host-authoritative physics | Avoids desync. Clients are visual-only for physics objects. |
| Primitives first | Characters are capsules/boxes until physics feel is right. Art comes last (Phase 7). |
| 100 Hz physics | `Time.fixedDeltaTime = 0.01f`. Required for joint stability with 15-body ragdolls. |
| PD balance (no I term) | Integral term causes windup with ragdolls. Use Proportional + Derivative only. |
| Layer-based self-collision filtering | Each player has a dedicated physics layer. `RagdollSetup` also calls `Physics.IgnoreCollision` for neighbouring parts. |

---

## Project-Specific Rules (Extend CODING_STANDARDS.md)

1. **All physics tuning parameters** (`kP`, `kD`, joint springs/dampers, force magnitudes, speed caps) must be `[SerializeField]` with `[Range]` attributes — never hardcoded literals.
2. **Joint configuration data** (angle limits, drive springs, mass) should live in ScriptableObjects or serialized structs so ragdoll variants are data-driven.
3. **Do not set `Rigidbody.velocity` directly** for gameplay movement. Use `AddForce` / `AddTorque` with appropriate `ForceMode`. Velocity clamping via `ClampMagnitude` is acceptable as a safety cap only.
4. **State machine transitions** must be explicit and logged at `Debug.Log` level during development (guarded by a `[SerializeField] bool _debugStateTransitions`).
5. **Networking guard pattern** — every `NetworkBehaviour` method that applies gameplay logic must be guarded:
   - Input reading: `if (!IsOwner) return;`
   - Physics / state mutation: `if (!IsServer) return;`
   - Visual-only client effects: `if (IsServer) return;`

---

## Phase Status Tracker

Update this section as phases are completed so future agents know the current state.

| Phase | Status | Notes |
|-------|--------|-------|
| 0 — Project Setup | **Complete** | Unity 6000.0.33f1, packages added, physics configured, layers 8–12 set, folder structure created. |
| 1 — Ragdoll Skeleton | **Complete** | `RagdollSetup.cs` done. `RagdollBuilder` Editor tool creates prefab. Tests passing. |
| 2 — Balance Controller | **Complete** | 2A joint drives, 2B `GroundSensor.cs`, 2C `BalanceController.cs` — PD torque, IsFallen, SetFacingDirection. All tests passing. |
| 3A — Player Input | **Complete** | Input action wiring done. |
| 3B1–3B3 — PlayerMovement | **Complete** | Movement forces, speed cap, `SetMoveInputForTest` seam added. |
| 3C1–3C3 — FSM + Get-Up | **Complete** | `CharacterState.cs` scaffold, transitions, fallen timer, get-up impulse + recovery timeout. |
| 3D1 — Yaw Torque Split | **Complete (2026-02-22)** | Split upright (pitch/roll) and yaw (world Y) into separate PD torques. `_kPYaw`, `_kDYaw` added. Airborne multiplier upright-only. |
| 3D2 — Yaw Stability Hardening | **Complete (2026-02-22)** | Dead zone `_yawDeadZoneDeg` (default 2°), normalised yaw vectors, zero-input facing retention, NaN guards. 59/59 PlayMode + 9 EditMode passing. |
| **3E1 — LegAnimator Core** | **Complete (2026-02-22)** | `LegAnimator.cs` on Hips. Phase accumulator from move input magnitude. Sinusoidal upper-leg alternation (L/R offset π). Constant knee-bend lower legs. Fallen/GettingUp bypass to identity. 18 new PlayMode tests; 77/77 PlayMode + 9/9 EditMode passing. |
| **3E2 — Leg Settle & Idle Blend** | **Complete (2026-02-22)** | `_idleBlendSpeed` serialized field added. Phase decay toward 0 on idle. `_smoothedInputMag` ramps 0→1 on gait re-entry (anti-pop). Legs snap to identity when idle. 8 new PlayMode tests; 85/85 PlayMode passing. |
| 3F1 — Jump Impulse | Not started | |
| 3F2 — Airborne Leg Spring | Not started | |
| 3G1 — Camera Follow | Not started | |
| 3G2 — Camera Scene Wiring | Not started | |
| 3T — Phase 3 Test Pass | Not started | |
| 4 — Grabbing & Combat | Not started | |
| 5 — Networking | Not started | |
| 6 — Game Loop & UI | Not started | |
| 7 — Polish & Juice | Not started | |

---

## Quick Workflow Reminder

Every task follows **CODING_STANDARDS.md §1** — the six mandatory phases:

```
A. Understand → B. Comment Design → C. Write Tests (red) → D. Implement (green) → E. Verify → F. Self-Review (F1–F10 checklist)
```

Present the F1–F10 self-review table to the user before committing. See `CODING_STANDARDS.md` §1 Phase F for the full checklist.

Run tests from the terminal using the commands in `AGENT_TEST_RUNNING.md`. Do not ask the user to open the Test Runner window.

### Unity Test Lock Guardrail

- Never run two Unity batch commands in parallel for the same project path.
- Before running tests, ensure no Unity process is open for this project.
- Run EditMode first, then PlayMode, and verify that `TestResults/*.xml` timestamps are freshly updated.
- Prefer the absolute-path `-NoProfile` invocation of `Tools/Run-UnityTests.ps1` for better terminal reliability.
- If Unity exits but `TestResults/*.xml` is missing, treat it as transient infra/lock race and rerun (up to 2–3 attempts) before concluding failure.

---

*Update this file whenever systems, namespaces, architecture, constraints, or phase status change.*
